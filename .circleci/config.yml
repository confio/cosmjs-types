version: 2.1

workflows:
  version: 2
  all-checks:
    jobs:
      - build

jobs:
  build:
    docker:
      - image: circleci/node:12-buster
    steps:
      - run:
          name: Install Git Large File Storage (LFS)
          command: sudo apt-get install git-lfs
      - checkout
      - run:
          name: Version information
          command: echo "node $(node --version)"; echo "yarn $(yarn --version)"
      - run:
          name: Install Dependencies
          command: yarn install --immutable --immutable-cache --check-cache
      - run:
          name: Code generator (.proto -> .ts)
          command: yarn define-proto
      - run:
          name: Ensure schemas are up-to-date
          command: |
            CHANGES_IN_REPO=$(git status --porcelain)
            if [[ -n "$CHANGES_IN_REPO" ]]; then
              echo "Repository is dirty. Showing 'git status' and 'git --no-pager diff' for debugging now:"
              git status && git --no-pager diff
              exit 1
            fi
      - run:
          name: Build (.ts -> .js/.d.ts)
          command: yarn define-proto
